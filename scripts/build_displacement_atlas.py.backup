#!/usr/bin/env python3
"""Displacement Risk Atlas v1.0 builder.

Generates a 20-page PDF analyzing 10 sectors approaching automation displacement thresholds.
Uses Jinja2 templates and Playwright HTML-to-PDF rendering for designed artifacts.
"""

from __future__ import annotations

import argparse
import sys
from pathlib import Path
from typing import Any, Dict, Sequence

from jinja2 import Environment, FileSystemLoader, select_autoescape

from product_build_utils import (
    BuildError,
    count_pdf_pages,
    ensure_dir,
    find_repo_root,
    git_head_commit,
    read_json,
    utc_now_iso,
    write_html_to_pdf,
    write_json,
    write_manifest,
)

BUILDER_NAME = "build_displacement_atlas"
BUILDER_VERSION = "v1.1"


def _require_str(run: Dict[str, Any], key: str) -> str:
    v = run.get(key)
    if not isinstance(v, str) or not v.strip():
        raise BuildError(f"run.json missing/invalid {key}")
    return v


def generate_cover_page() -> list[str]:
    """Generate cover page content."""
    return [
        "",
        "DISPLACEMENT RISK ATLAS",
        "",
        "Procedural analysis of 10 sectors",
        "approaching automation thresholds",
        "",
        "Version 1.0 (2026-W06)",
        "",
        "NOT career advice. NOT financial advice.",
        "Pattern documentation only.",
        "",
        "CrisisCore Systems",
        "February 2026",
        "",
    ]


def generate_framework_pages() -> list[str]:
    """Generate framework section (pages 2-6)."""
    content = []
    
    # Page 2-3: Leverage Destruction Mechanism
    content.extend([
        "",
        "PART 1: FRAMEWORK",
        "",
        "1. LEVERAGE DESTRUCTION MECHANISM",
        "",
        "How automation reduces worker bargaining power:",
        "",
        "- Task commoditization vs. irreplaceability",
        "- Bargaining Power = f(Task Complexity, Replacement Cost)",
        "- Threshold: When replacement cost < automation cost",
        "",
        "When automation can do your work,",
        "your bargaining power collapses.",
        "",
        "Not because the job disappears immediately.",
        "Because your leverage disappears first.",
        "",
    ])
    
    # Page 4: Bargaining Power Threshold Model
    content.extend([
        "2. BARGAINING POWER THRESHOLD MODEL",
        "",
        "Junior vs. Senior dynamics:",
        "",
        "- Juniors: Lower replacement cost, routine tasks",
        "- Seniors: Higher replacement cost, judgment tasks",
        "",
        "The 50% automation penetration threshold:",
        "",
        "When >50% of tasks are automated,",
        "leverage approaches zero.",
        "",
    ])
    
    # Page 5: Cascading Displacement Pattern
    content.extend([
        "3. CASCADING DISPLACEMENT PATTERN",
        "",
        "Historical precedent:",
        "",
        "- Manufacturing (1980s-2000s)",
        "- Clerical work (1990s-2010s)",
        "- Customer service (2010s-2020s)",
        "",
        "Labor flood mechanism:",
        "Displaced workers seek adjacent markets.",
        "",
        "AI era: Timeline compression from 10-20 years to 2-5 years.",
        "",
    ])
    
    # Page 6: Mitigation Framework
    content.extend([
        "4. MITIGATION FRAMEWORK",
        "",
        "Four pattern categories:",
        "",
        "1. Leverage preservation strategies",
        "2. Non-commoditizable skill identification",
        "3. Market position shifting",
        "4. Portfolio approaches",
        "",
        "NOT prescriptive. Pattern identification only.",
        "",
    ])
    
    return content


def generate_sector_page(sector_name: str, sector_data: Dict[str, Any]) -> list[str]:
    """Generate one sector analysis page."""
    content = [
        "",
        f"SECTOR: {sector_name.upper()}",
        "",
        f"Current automation penetration: {sector_data.get('penetration', '??')}%",
        f"Threshold proximity: {sector_data.get('proximity', '?')}/10",
        "",
        "Task commoditization indicators:",
        "",
    ]
    
    for task in sector_data.get('routine_tasks', []):
        content.append(f"- {task}")
    
    content.extend([
        "",
        "Adjacent market pressure points:",
        "",
    ])
    
    for market in sector_data.get('adjacent_markets', []):
        content.append(f"- {market}")
    
    content.extend([
        "",
        "Timeline estimate (procedural, not predictive):",
        f"- Near-term (0-2 years): {sector_data.get('near_term', 'Data pending')}",
        f"- Mid-term (2-5 years): {sector_data.get('mid_term', 'Data pending')}",
        "",
    ])
    
    return content


def generate_mitigation_pages() -> list[str]:
    """Generate mitigation patterns section (pages 17-19)."""
    content = []
    
    # Page 17: Pattern Categories 1 & 2
    content.extend([
        "",
        "PART 3: MITIGATION PATTERNS",
        "",
        "NOT PRESCRIPTIVE. NOT ADVICE. PATTERN DOCUMENTATION.",
        "",
        "Pattern Category 1: Leverage Preservation",
        "",
        "Observable patterns:",
        "- Shifting to non-routine tasks",
        "- Building cross-functional knowledge",
        "- Developing judgment-intensive skills",
        "",
        "Pattern Category 2: Non-Commoditizable Skills",
        "",
        "Observable patterns:",
        "- High-context, high-ambiguity domains",
        "- Interpersonal dynamics, negotiation",
        "- Creative synthesis",
        "",
    ])
    
    # Page 18: Pattern Categories 3 & 4
    content.extend([
        "Pattern Category 3: Market Position Shifting",
        "",
        "Observable patterns:",
        "- Moving to adjacent roles before displacement",
        "- Geographic arbitrage considerations",
        "- Sector rotation timing",
        "",
        "Pattern Category 4: Portfolio Approaches",
        "",
        "Observable patterns:",
        "- Multiple income streams",
        "- Skill diversification",
        "- Platform vs. full-time employment",
        "",
    ])
    
    # Page 19: Disclaimers
    content.extend([
        "LIMITATIONS & DISCLAIMERS",
        "",
        "This atlas is NOT:",
        "- Career advice",
        "- Financial advice",
        "- Guaranteed outcomes",
        "- Prescriptive recommendations",
        "",
        "This atlas IS:",
        "- Mechanism analysis",
        "- Pattern documentation",
        "- Procedural observation",
        "- System description",
        "",
        "Use at your own discretion.",
        "No guarantees or promises.",
        "Timeline estimates are not predictions.",
        "",
    ])
    
    return content


def generate_about_page() -> list[str]:
    """Generate about/contact page (page 20)."""
    return [
        "",
        "ABOUT CRISISCORE SYSTEMS",
        "",
        "CrisisCore Systems analyzes displacement mechanisms,",
        "distributed credit systems, and attention infrastructure.",
        "",
        "No hype. No predictions. Pattern recognition only.",
        "",
        "Field notes delivered weekly.",
        "Subscribe: forge.crisiscore.systems",
        "",
        "Contact: support@crisiscore.systems",
        "",
        "Version History:",
        "- v1.0 (2026-W06): Initial release",
        "",
        "License:",
        "Personal use: $19 | Commercial use: $99",
        "See licenses/ directory for full terms.",
        "",
    ]


def load_sector_data(product_dir: Path) -> list[Dict[str, Any]]:
    """Load sector data from JSON file."""
    sectors_file = product_dir / "data" / "sectors.json"
    if not sectors_file.exists():
        raise BuildError(f"Sectors data file not found: {sectors_file}")
    
    data = read_json(sectors_file)
    return data.get("sectors", [])


def render_html_template(
    template_dir: Path,
    template_name: str,
    context: Dict[str, Any],
    output_path: Path,
) -> None:
    """Render Jinja2 template to HTML file."""
    try:
        env = Environment(
            loader=FileSystemLoader(str(template_dir)),
            autoescape=select_autoescape(["html", "xml"]),
        )
        template = env.get_template(template_name)
        html_content = template.render(**context)
        output_path.write_text(html_content, encoding="utf-8")
    except Exception as exc:
        raise BuildError(f"Failed to render template {template_name}: {exc}") from exc


def build_pdf(out_path: Path, content_lines: list[str], title: str) -> None:
    """Build PDF using minimal PDF writer."""
    write_minimal_pdf(out_path, title=title, body_lines=content_lines)


def main(argv: Sequence[str]) -> int:
    ap = argparse.ArgumentParser(description="Build Displacement Risk Atlas v1.0")
    ap.add_argument("--run-json", required=True, help="Path to run.json")
    ap.add_argument("--out-dir", default=None, help="Output directory (defaults to same dir as run.json)")
    args = ap.parse_args(argv)

    run_json_path = Path(args.run_json).resolve()
    if not run_json_path.exists():
        print(f"ERROR: run.json not found: {run_json_path}", file=sys.stderr)
        return 1

    try:
        run = read_json(run_json_path)
    except BuildError as e:
        print(f"ERROR: {e}", file=sys.stderr)
        return 1

    run_id = _require_str(run, "run_id")
    asset_id = _require_str(run, "product_id")
    version = _require_str(run, "version")

    if args.out_dir:
        out_dir = Path(args.out_dir).resolve()
    else:
        out_dir = run_json_path.parent / "outputs"

    ensure_dir(out_dir)

    repo_root = find_repo_root(run_json_path)
    repo_commit = git_head_commit(repo_root) or "unknown"
    generated_at = utc_now_iso()

    print(f"Building Displacement Risk Atlas v{version}")
    print(f"Run ID: {run_id}")
    print(f"Output directory: {out_dir}")

    # Generate full content
    all_content = []
    
    # Cover page
    all_content.extend(generate_cover_page())
    
    # Framework (pages 2-6)
    all_content.extend(generate_framework_pages())
    
    # Sector analysis (pages 7-16)
    all_content.append("")
    all_content.append("PART 2: SECTOR ANALYSIS (10 SECTORS)")
    all_content.append("")
    
    sectors = get_sector_data()
    for i, (sector_name, sector_data) in enumerate(sectors.items(), start=1):
        all_content.extend(generate_sector_page(sector_name, sector_data))
    
    # Mitigation patterns (pages 17-19)
    all_content.extend(generate_mitigation_pages())
    
    # About page (page 20)
    all_content.extend(generate_about_page())

    # Build full PDF
    full_pdf_path = out_dir / f"displacement_risk_atlas_v{version}.pdf"
    print(f"Generating full PDF: {full_pdf_path.name}")
    build_pdf(full_pdf_path, all_content, "Displacement Risk Atlas")

    # Build preview PDF (first 3 pages: cover + framework intro)
    preview_content = []
    preview_content.extend(generate_cover_page())
    preview_content.extend([
        "",
        "PREVIEW VERSION",
        "",
        "This preview includes:",
        "- Cover page",
        "- Framework overview (excerpt)",
        "- Sample sector analysis (AI/ML Engineering)",
        "",
        "Full atlas includes:",
        "- Complete framework (5 pages)",
        "- 10 sector analyses (10 pages)",
        "- Mitigation patterns (3 pages)",
        "",
    ])
    preview_content.extend(generate_framework_pages()[:30])  # Partial framework
    preview_content.extend([
        "",
        "SAMPLE SECTOR: AI/ML ENGINEERING (JUNIOR)",
        "",
    ])
    preview_content.extend(generate_sector_page("AI/ML Engineering (Junior)", sectors["AI/ML Engineering (Junior)"]))
    preview_content.extend([
        "",
        "Full atlas: $19 (personal) | $99 (commercial)",
        "Available at: forge.crisiscore.systems",
        "",
    ])

    preview_pdf_path = out_dir / "displacement_risk_atlas_preview.pdf"
    print(f"Generating preview PDF: {preview_pdf_path.name}")
    build_pdf(preview_pdf_path, preview_content, "Displacement Risk Atlas - Preview")

    # Create markdown version for documentation
    md_path = out_dir / f"displacement_risk_atlas_v{version}.md"
    print(f"Generating markdown: {md_path.name}")
    md_path.write_text("\n".join(all_content), encoding="utf-8")

    # Write manifest
    manifest_path = out_dir / "manifest.json"
    print(f"Writing manifest: {manifest_path.name}")
    
    input_files = [run_json_path]
    output_files = [full_pdf_path, preview_pdf_path, md_path]
    
    write_manifest(
        out_path=manifest_path,
        run_id=run_id,
        asset_id=asset_id,
        asset_version=version,
        repo_root=repo_root,
        repo_commit=repo_commit,
        generated_at_utc=generated_at,
        builder_name=BUILDER_NAME,
        builder_version=BUILDER_VERSION,
        manifest_schema_ref="../../../artifacts/manifest.schema.json",
        input_files=input_files,
        output_files=output_files,
        unresolved_template_vars=[],
    )

    # Update run.json status
    run["status"] = "completed"
    run["build_completed_at"] = generated_at
    run["builder"] = {
        "name": BUILDER_NAME,
        "version": BUILDER_VERSION
    }
    write_json(run_json_path, run)

    print("\nâœ“ Build completed successfully!")
    print(f"  - Full PDF: {full_pdf_path.name} ({full_pdf_path.stat().st_size} bytes)")
    print(f"  - Preview PDF: {preview_pdf_path.name} ({preview_pdf_path.stat().st_size} bytes)")
    print(f"  - Markdown: {md_path.name}")
    print(f"  - Manifest: {manifest_path.name}")
    
    return 0


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
